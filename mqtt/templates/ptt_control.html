<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web对讲系统</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .ptt-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s;
        }
        .ptt-inactive {
            background-color: #28a745;
            color: white;
        }
        .ptt-active {
            background-color: #dc3545;
            color: white;
            transform: scale(0.95);
        }
        .control-button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .listen-active {
            background-color: #17a2b8;
            color: white;
        }
        .listen-inactive {
            background-color: #6c757d;
            color: white;
        }
        .audio-controls {
            text-align: center;
            margin: 20px 0;
        }
        .status-info {
            margin: 10px 0;
            padding: 8px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Web对讲系统</h1>
        
        <div id="connectionStatus" class="status disconnected">
            连接中...
        </div>

        <div class="status-info">
            <div>设备ID: <span id="deviceId">web_ptt_1</span></div>
            <div>MQTT服务器: <span id="mqttServer">24.233.0.55:1883</span></div>
        </div>

        <div class="audio-controls">
            <h3>对讲控制</h3>
            <button id="pttButton" class="ptt-button ptt-inactive" 
                    ontouchstart="startPTT()" ontouchend="stopPTT()"
                    onmousedown="startPTT()" onmouseup="stopPTT()" onmouseleave="stopPTT()">
                按住说话
            </button>
            
            <h3>监听控制</h3>
            <button id="listenButton" class="control-button listen-active" onclick="toggleListening()">
                停止监听
            </button>
        </div>

        <div class="status-info">
            <div>状态: <span id="statusText">就绪</span></div>
            <div>音频输入: <span id="audioInputStatus">等待授权</span></div>
        </div>
    </div>

    <script>
        const socket = io();
        let isConnected = false;
        let isListening = true;
        let isPTTActive = false;
        let mediaStream = null;
        let audioContext = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // 连接状态处理
        socket.on('connect', () => {
            console.log('连接到服务器');
            isConnected = true;
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('与服务器断开连接');
            isConnected = false;
            updateConnectionStatus(false);
        });

        socket.on('connection_status', (data) => {
            isListening = data.listening;
            updateListenButton();
        });

        socket.on('listening_status', (data) => {
            isListening = data.enabled;
            updateListenButton();
        });

        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = '已连接到对讲系统';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '连接断开';
            }
        }

        // 更新监听按钮状态
        function updateListenButton() {
            const button = document.getElementById('listenButton');
            if (isListening) {
                button.className = 'control-button listen-active';
                button.textContent = '停止监听';
            } else {
                button.className = 'control-button listen-inactive';
                button.textContent = '开始监听';
            }
        }

        // 切换监听状态
        function toggleListening() {
            isListening = !isListening;
            socket.emit('toggle_listening', { enabled: isListening });
            updateListenButton();
        }

        // 开始PTT
        function startPTT() {
            if (!isPTTActive && isConnected) {
                isPTTActive = true;
                document.getElementById('pttButton').className = 'ptt-button ptt-active';
                document.getElementById('pttButton').textContent = '说话中...';
                socket.emit('ptt_start');
                
                // 开始录音
                startRecording();
            }
        }

        // 停止PTT
        function stopPTT() {
            if (isPTTActive) {
                isPTTActive = false;
                document.getElementById('pttButton').className = 'ptt-button ptt-inactive';
                document.getElementById('pttButton').textContent = '按住说话';
                socket.emit('ptt_stop');
                
                // 停止录音
                stopRecording();
            }
        }

        // 初始化音频录制
        async function initAudio() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                document.getElementById('audioInputStatus').textContent = '就绪';
                
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(mediaStream);
                
                // 设置音频处理节点
                const processor = audioContext.createScriptProcessor(1024, 1, 1);
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
        processor.onaudioprocess = (event) => {
            if (isPTTActive && isConnected) {
                const inputData = event.inputBuffer.getChannelData(0);
                const outputData = new Uint8Array(inputData.length);
                
                // 模拟ESP32的转换逻辑：将浮点数(-1到1)转换为16位有符号(-32768到32767)
                // 然后转换为8位无符号(0-255)，使用相同的算法：(sample + 32768) >> 8
                for (let i = 0; i < inputData.length; i++) {
                    // 将浮点数(-1到1)转换为16位有符号整数(-32768到32767)
                    const int16Sample = Math.max(-32768, Math.min(32767, Math.floor(inputData[i] * 32767)));
                    // 使用ESP32相同的转换算法：(sample + 32768) >> 8
                    outputData[i] = (int16Sample + 32768) >> 8;
                }
                
                // 发送音频数据
                const audioBase64 = arrayBufferToBase64(outputData.buffer);
                socket.emit('audio_send', { audio: audioBase64 });
            }
        };

        // 辅助函数：ArrayBuffer 转 Base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
                
            } catch (error) {
                console.error('音频初始化失败:', error);
                document.getElementById('audioInputStatus').textContent = '错误: ' + error.message;
            }
        }

        // 开始录音（兼容性方案）
        async function startRecording() {
            if (!mediaStream) {
                await initAudio();
            }
        }

        // 停止录音
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initAudio();
            updateConnectionStatus(false);
            updateListenButton();
        });

        // 防止移动端滚动
        document.addEventListener('touchmove', function(e) {
            if (isPTTActive) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>