# 张de三方 - 影视导播指挥解决方案

一个基于ESP32的影视三方通话和TALLY灯结合的智能导播指挥系统。

## 功能特性

- 🎤 **双向语音通信**：基于MQTT的高质量音频传输
- 🎚️ **智能开麦控制**：支持开麦键模式和远程MQTT控制
- 🔊 **音量控制**：支持扬声器输出音量调节（0-100%）
- 📡 **远程音量控制**：通过MQTT远程查询和设置音量
- 💡 **智能TALLY灯**：支持vMix集成和MQTT远程控制
- 🛡️ **系统稳定性**：I2S超时保护，杜绝硬件故障导致死机
- 📶 **智能配网**：Web界面快速配置WiFi和vMix设置
- 🌐 **远程管理**：局域网Web界面管理设备配置
- 🔄 **状态查询**：支持远程查询设备、麦克风和音量状态

## 硬件要求

- ESP32开发板
- I2S麦克风模块
- I2S扬声器模块
- RGB LED灯模块
- 按键开关

## 快速开始

### 1. 设备配网

1. 设备上电后，等待启动完成
2. 手机或电脑搜索WiFi热点：`zhsf_设备ID`（如：zhsf_zhsf_1）
3. 连接该热点，自动弹出配网页面（或手动访问192.168.4.1）
4. 配置以下参数：
   - **WiFi名称**：选择要连接的WiFi网络
   - **WiFi密码**：输入对应密码
   - **vMix控制**：如需vMix集成，输入1，否则保持0
   - **vMix IP**：输入vMix主机的IP地址（无需端口号）
   - **Output Volume %**：设置扬声器输出音量百分比（0-100，默认10%）

5. 点击"保存配置"，设备将自动重启并连接指定网络

### 2. vMix配置（可选）

如需使用vMix TALLY功能：
1. 在vMix软件中启用TALLY输出
2. 在设备配网页面启用vMix控制并设置vMix主机IP
3. 设备将自动连接vMix并订阅TALLY状态

### 3. 使用说明

#### 音频通话

- **开麦**：短按按键切换到开麦模式（LED常亮）
- **关麦**：再次短按切换到关麦模式（LED熄灭）
- **讲话**：开麦模式下持续发送音频，无需按住按键
- **收听**：始终收听其他设备音频
- **状态指示**：
  - 开麦模式：LED常亮
  - 关麦模式：LED熄灭（有音频传入时闪烁）


#### TALLY灯控制

**通过MQTT控制：**
- 主题：`zhsf/tally`
- 指令格式：`设备ID:模式代号`
- 示例：`zhsf_1:5`（设置zhsf_1设备为红灯常亮）

**支持的模式代号：**
- `0` - 关闭
- `1` - 绿灯常亮（默认）
- `2` - 黄灯闪烁
- `3` - 黄灯常亮  
- `4` - 红灯闪烁
- `5` - 红灯常亮
- `6` - 红蓝交替

**状态查询：**
- 发送：`zhsf_1:n`
- 返回：`[re]zhsf_1:当前模式代号`

#### 麦克风控制

**通过MQTT控制麦克风状态：**
- 主题：`zhsf/tally` （和灯控同主题）
- 指令格式：`设备ID:指令代号`

**支持的指令：**
- `zhsf_1:m` - 查询麦克风状态
  - 返回：`[re]zhsf_1:g`（关麦）或`[re]zhsf_1:k`（开麦）
- `zhsf_1:g` - 关麦指令
  - 功能：强制关闭麦克风（如果当前开麦则切换到关麦）
- `zhsf_1:k` - 开麦指令
  - 功能：强制开启麦克风（如果当前关麦则切换到开麦）

#### 音量控制

**通过MQTT控制扬声器输出音量：**
- 主题：`zhsf/tally` （和灯控同主题）
- 指令格式：`设备ID:指令代号`

**支持的指令：**
- `zhsf_1:nv` - 查询当前音量水平
  - 返回：`[re]zhsf_1:v10`（10代表10%音量）
- `zhsf_1:v20` - 设置音量为20%
  - 功能：设置扬声器输出音量为20%，范围0-100
  - 音量设置会自动保存，重启后保持不变

**音量设置说明：**
- 0 = 静音
- 100 = 最大音量
- 默认音量为10%
- 可以通过配网界面或MQTT远程设置音量
- 两种设置方式互不冲突，都会持久化保存

#### vMix TALLY集成
- 设备自动连接vMix并订阅TALLY状态
- Program状态：红灯常亮（模式5）
- Preview状态：黄灯闪烁（模式2）
- 未激活状态：允许MQTT控制

#### Web管理
配网成功后，可通过Web界面重置配置：
- 访问：`http://设备IP/forget`
- 功能：忘记当前WiFi配置并重启进入配网模式

## 网络配置

### MQTT服务器
- 地址：24.233.0.55
- 端口：1883
- 用户名：esptalk
- 密码：zhsanfang

### vMix集成
- TCP端口：8099
- 协议：vMix TALLY协议

## 故障排除

### 常见问题

1. **无法配网**
   - 检查热点名称是否正确
   - 确认设备进入配网模式

2. **无法连接MQTT**
   - 检查WiFi连接状态
   - 验证MQTT服务器配置

3. **vMix连接失败**
   - 确认vMix主机IP正确
   - 检查vMix TALLY功能已启用

4. **音频问题**
   - 检查麦克风和扬声器连接
   - 确认I2S配置正确

### 重置设备

如需重置设备配置：
访问Web：`http://设备IP/forget`


## 开发信息

### 项目结构
```
mqtt/           - ESP32固件源码
python/         - 测试工具和模拟器
ctrl/           - 控制界面文件
```

### 编译说明
1. 使用PlatformIO或Arduino IDE编译
2. 安装必要的库依赖：
   - WiFiManager
   - PubSubClient
   - WebServer

## 技术支持

如有问题或建议，请联系项目维护团队。

## 版本历史

- v1.0 - 初始版本，支持基本通话和TALLY功能
- v1.1 - 添加vMix集成和Web管理功能
- v1.2 - 优化配网流程和状态查询
- v1.3 - 添加开麦键模式和MQTT麦克风远程控制
- v1.4 - 添加扬声器音量控制和MQTT远程音量调节

Note:本项目参考和修改了一些已存在的开源代码，由于其中部分仓库没有License并且署名不全，此处无法精准的列出其名录。对这些部分代码的版权归原作者所有。
如有侵权，请提交Issue，我们将尽快处理。
---

*张de三方 - 让影视制作更智能*
