# 系统架构图

## 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                      电脑主设备                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                  Python后端服务                     │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │ WebSocket   │  │  音频混合   │  │  录音服务   │  │  │
│  │  │  服务器     │  │  处理器     │  │             │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│  └─────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                 Web前端界面                         │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │ 设备状态    │  │ 音频控制    │  │ Tally控制   │  │  │
│  │  │ 监控面板    │  │ 面板        │  │ 面板        │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ WiFi热点 (2.4GHz)
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  ESP32设备1   │   │  ESP32设备2   │   │  ESP32设备3   │
│ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │
│ │蓝牙音频   │ │   │ │蓝牙音频   │ │   │ │蓝牙音频   │ │
│ │模块       │ │   │ │模块       │ │   │ │模块       │ │
│ └───────────┘ │   │ └───────────┘ │   │ └───────────┘ │
│ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │
│ │状态LED    │ │   │ │状态LED    │ │   │ │状态LED    │ │
│ │(GPIO22)   │ │   │ │(GPIO22)   │ │   │ │(GPIO22)   │ │
│ └───────────┘ │   │ └───────────┘ │   │ └───────────┘ │
│ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │
│ │Tally RGB  │ │   │ │Tally RGB  │ │   │ │Tally RGB  │ │
│ │LED        │ │   │ │LED        │ │   │ │LED        │ │
│ └───────────┘ │   │ └───────────┘ │   │ └───────────┘ │
│ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │
│ │闭麦按键   │ │   │ │闭麦按键   │ │   │ │闭麦按键   │ │
│ └───────────┘ │   │ └───────────┘ │   │ └───────────┘ │
└───────────────┘   └───────────────┘   └───────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
  蓝牙耳机1            蓝牙耳机2            蓝牙耳机3
```

## 数据流架构
```
音频数据流:
蓝牙耳机 → ESP32 → WiFi → 电脑(音频混合) → WiFi → ESP32 → 蓝牙耳机
         ↖_________________________________________↙

控制数据流:
电脑Web界面 → WebSocket → ESP32 (控制指令)
ESP32状态 → WebSocket → 电脑Web界面 (状态更新)

设备发现:
ESP32 → mDNS/Broadcast → 电脑自动发现
```

## 通信协议
```
1. 控制通道: WebSocket (JSON格式)
   - 心跳包: {"type": "heartbeat", "device_id": "esp32_1"}
   - 状态更新: {"type": "status", "mic_muted": false, "tally_light": "green"}
   - 控制指令: {"type": "control", "command": "mute", "value": true}

2. 音频通道: UDP流 (Opus编码)
   - 采样率: 16kHz
   - 比特率: 32kbps
   - 包大小: 20ms
```

## 硬件接口
```
ESP32引脚分配:
- GPIO22: 状态LED (低电平亮)
- GPIO23: Tally灯红色
- GPIO18: Tally灯绿色  
- GPIO19: Tally灯蓝色
- GPIO21: 闭麦按键 (低电平触发)
- GPIO32/33: I2S音频接口
```

## 软件模块
```
电脑端模块:
- hotspot_manager.py: WiFi热点管理
- websocket_server.py: WebSocket服务
- audio_mixer.py: 音频混合处理
- recorder.py: 录音功能
- web_interface.py: Web界面服务

ESP32模块:
- wifi_connector.ino: WiFi连接
- bluetooth_audio.ino: 蓝牙音频
- led_controller.ino: LED控制
- button_handler.ino: 按键处理
- websocket_client.ino: WebSocket客户端