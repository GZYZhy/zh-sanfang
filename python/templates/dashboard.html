<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ deä¸‰æ–¹ - ç»¼åˆæ§åˆ¶å°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, button, input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #3498db; color: white; cursor: pointer; }
        button:hover { background: #2980b9; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ å¼ deä¸‰æ–¹ - ç»¼åˆæ§åˆ¶å°</h1>
            <p>å½±è§†å¯¼æ’­æŒ‡æŒ¥ç³»ç»Ÿ</p>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="card" style="grid-column: 1 / -1; margin-bottom: 20px;">
            <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ</h3>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; color: #3498db;">ğŸµ</div>
                    <div id="systemAudioStatus">éŸ³é¢‘: æœªç›‘å¬</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; color: #e74c3c;">ğŸ“¦</div>
                    <div id="systemPackets">æ•°æ®åŒ…: 0</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; color: #27ae60;">ğŸ“±</div>
                    <div id="systemDevices">è®¾å¤‡: 3ä¸ª</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; color: #f39c12;">â°</div>
                    <div id="systemTime">æ—¶é—´: --:--:--</div>
                </div>
            </div>
            <button onclick="refreshSystemStatus()" style="margin-top: 15px;">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="grid">
            <!-- RGBç¯æ§åˆ¶ -->
            <div class="card">
                <h3>ğŸ’¡ RGBç¯æ§åˆ¶</h3>
                <div class="control-group">
                    <label>è®¾å¤‡:</label>
                    <select id="rgbDevice">
                        <option value="zhsf_1">zhsf_1</option>
                        <option value="zhsf_2">zhsf_2</option>
                        <option value="zhsf_3">zhsf_3</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>æ¨¡å¼:</label>
                    <select id="rgbMode">
                        <option value="0">å…³é—­</option>
                        <option value="1" selected>ç»¿è‰²å¸¸äº®</option>
                        <option value="2">é»„è‰²é—ªçƒ</option>
                        <option value="3">é»„è‰²å¸¸äº®</option>
                        <option value="4">çº¢è‰²é—ªçƒ</option>
                        <option value="5">çº¢è‰²å¸¸äº®</option>
                        <option value="6">çº¢è“äº¤æ›¿</option>
                    </select>
                </div>
                <button onclick="sendRGBControl()">å‘é€æ§åˆ¶</button>
                <div id="rgbStatus" class="status hidden"></div>
            </div>

            <!-- éº¦å…‹é£æ§åˆ¶ -->
            <div class="card">
                <h3>ğŸ¤ éº¦å…‹é£æ§åˆ¶</h3>
            <div class="control-group">
                    <label>è®¾å¤‡:</label>
                    <select id="micDevice">
                    <option value="zhsf_1">zhsf_1</option>
                    <option value="zhsf_2">zhsf_2</option>
                    <option value="zhsf_3">zhsf_3</option>
                </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="controlMic('mute')">é™éŸ³</button>
                    <button onclick="controlMic('unmute')">å¼€éº¦</button>
                    <button onclick="queryMic()">æŸ¥è¯¢çŠ¶æ€</button>
                </div>
                <div id="micStatus" class="status hidden"></div>
            </div>

            <!-- éŸ³é‡æ§åˆ¶ -->
            <div class="card">
                <h3>ğŸ”Š éŸ³é‡æ§åˆ¶</h3>
                <div class="control-group">
                    <label>è®¾å¤‡:</label>
                    <select id="volDevice">
                        <option value="zhsf_1">zhsf_1</option>
                        <option value="zhsf_2">zhsf_2</option>
                        <option value="zhsf_3">zhsf_3</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>éŸ³é‡ (0-100):</label>
                    <input type="number" id="volume" min="0" max="100" value="10">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="setVolume()">è®¾ç½®éŸ³é‡</button>
                    <button onclick="queryVolume()">æŸ¥è¯¢éŸ³é‡</button>
                </div>
                <div id="volStatus" class="status hidden"></div>
            </div>

            <!-- éŸ³é¢‘ç›‘å¬ -->
            <div class="card">
                <h3>ğŸ“» éŸ³é¢‘ç›‘å¬</h3>
                <div style="text-align: center;">
                    <div id="audioStatus">çŠ¶æ€: æœªç›‘å¬<br>åŒ…æ•°: 0</div>
                    <br>
                    <button id="audioBtn" onclick="toggleAudio()">å¼€å§‹ç›‘å¬</button>
                </div>
                <div id="audioControlStatus" class="status hidden"></div>
            </div>

            <!-- è®¾å¤‡çŠ¶æ€ -->
            <div class="card">
                <h3>ğŸ“Š è®¾å¤‡çŠ¶æ€</h3>
            <div class="control-group">
                    <label>è®¾å¤‡:</label>
                    <select id="statusDevice">
                        <option value="zhsf_1">zhsf_1</option>
                        <option value="zhsf_2">zhsf_2</option>
                        <option value="zhsf_3">zhsf_3</option>
                </select>
                </div>
                <button onclick="queryDeviceStatus()">æŸ¥è¯¢è®¾å¤‡çŠ¶æ€</button>
                <button onclick="queryAllDevices()" style="margin-left: 10px;">æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡</button>
                <div id="deviceStatus" class="status hidden"></div>
            </div>

            <!-- æ‰¹é‡æ§åˆ¶ -->
            <div class="card">
                <h3>âš¡ æ‰¹é‡æ§åˆ¶</h3>
                <div class="control-group">
                    <label>é€‰æ‹©è®¾å¤‡:</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label><input type="checkbox" id="batch_zhsf_1" checked> zhsf_1</label>
                        <label><input type="checkbox" id="batch_zhsf_2" checked> zhsf_2</label>
                        <label><input type="checkbox" id="batch_zhsf_3" checked> zhsf_3</label>
                    </div>
                </div>

                <div class="control-group">
                    <label>æ“ä½œç±»å‹:</label>
                    <select id="batchAction">
                        <option value="rgb">è®¾ç½®RGBç¯æ¨¡å¼</option>
                        <option value="microphone">æ§åˆ¶éº¦å…‹é£</option>
                        <option value="volume">è®¾ç½®éŸ³é‡</option>
                    </select>
        </div>

                <div id="batchParams">
                    <!-- å‚æ•°å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

                <button onclick="executeBatchControl()" style="width: 100%; margin-top: 15px;">æ‰§è¡Œæ‰¹é‡æ§åˆ¶</button>
                <div id="batchStatus" class="status hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // RGBæ§åˆ¶
        async function sendRGBControl() {
            const device = document.getElementById('rgbDevice').value;
            const mode = document.getElementById('rgbMode').value;
            
            showStatus('rgbStatus', 'å‘é€ä¸­...', 'info');
            
            try {
                const response = await fetch('/zhsf/api/rgb/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device, mode })
                });
                
                const result = await response.json();
                showStatus('rgbStatus', result.message, result.status === 'success' ? 'success' : 'error');
            } catch (error) {
                showStatus('rgbStatus', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // éº¦å…‹é£æ§åˆ¶
        async function controlMic(action) {
            const device = document.getElementById('micDevice').value;

            showStatus('micStatus', 'æ“ä½œä¸­...', 'info');

            try {
                const response = await fetch(`/zhsf/api/microphone/${device}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });

                const result = await response.json();
                showStatus('micStatus', result.message, result.status === 'success' ? 'success' : 'error');
            } catch (error) {
                showStatus('micStatus', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        async function queryMic() {
            const device = document.getElementById('micDevice').value;

            showStatus('micStatus', 'æŸ¥è¯¢ä¸­...', 'info');

            try {
                const response = await fetch(`/zhsf/api/microphone/${device}/query`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const status = result.response === 'g' ? 'é™éŸ³' : result.response === 'k' ? 'å¼€éº¦' : 'æœªçŸ¥';
                    showStatus('micStatus', `çŠ¶æ€: ${status}`, 'success');
                } else {
                    showStatus('micStatus', result.message, 'error');
                }
            } catch (error) {
                showStatus('micStatus', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // éŸ³é‡æ§åˆ¶
        async function setVolume() {
            const device = document.getElementById('volDevice').value;
            const volume = document.getElementById('volume').value;

            showStatus('volStatus', 'è®¾ç½®ä¸­...', 'info');

            try {
                const response = await fetch(`/zhsf/api/volume/${device}/set`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ volume: parseInt(volume) })
                });

                const result = await response.json();
                showStatus('volStatus', result.message, result.status === 'success' ? 'success' : 'error');
            } catch (error) {
                showStatus('volStatus', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        async function queryVolume() {
            const device = document.getElementById('volDevice').value;

            showStatus('volStatus', 'æŸ¥è¯¢ä¸­...', 'info');

            try {
                const response = await fetch(`/zhsf/api/volume/${device}/query`);
                const result = await response.json();

                if (result.status === 'success') {
                    const vol = result.response.replace('v', '');
                    document.getElementById('volume').value = vol;
                    showStatus('volStatus', `éŸ³é‡: ${vol}%`, 'success');
                } else {
                    showStatus('volStatus', result.message, 'error');
                }
            } catch (error) {
                showStatus('volStatus', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // éŸ³é¢‘ç›‘å¬
        let audioListening = false;
        let statusInterval = null;

        async function toggleAudio() {
            const btn = document.getElementById('audioBtn');
            const url = audioListening ? '/zhsf/api/audio/stop' : '/zhsf/api/audio/start';

            showStatus('audioControlStatus', 'æ“ä½œä¸­...', 'info');

            try {
                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (data.message.includes('å¼€å§‹') || data.message.includes('å¯åŠ¨')) {
                    audioListening = true;
                    btn.textContent = 'åœæ­¢ç›‘å¬';
                    btn.style.background = '#e74c3c';
                    if (!statusInterval) {
                        statusInterval = setInterval(updateAudioStatus, 1000);
                    }
                } else {
                    audioListening = false;
                    btn.textContent = 'å¼€å§‹ç›‘å¬';
                    btn.style.background = '#3498db';
                    if (statusInterval) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                    }
                }

                showStatus('audioControlStatus', data.message, 'success');
            } catch (error) {
                showStatus('audioControlStatus', 'æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function updateAudioStatus() {
            try {
                const response = await fetch('/zhsf/api/audio/status');
                const data = await response.json();

                audioListening = data.listening;
                const statusDiv = document.getElementById('audioStatus');
                statusDiv.innerHTML = `çŠ¶æ€: ${data.listening ? 'ç›‘å¬ä¸­' : 'æœªç›‘å¬'}<br>åŒ…æ•°: ${data.count}`;

                const btn = document.getElementById('audioBtn');
                if (data.listening) {
                    btn.textContent = 'åœæ­¢ç›‘å¬';
                    btn.style.background = '#e74c3c';
                } else {
                    btn.textContent = 'å¼€å§‹ç›‘å¬';
                    btn.style.background = '#3498db';
                }
            } catch (error) {
                console.error('æ›´æ–°éŸ³é¢‘çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // è®¾å¤‡çŠ¶æ€æŸ¥è¯¢
        async function queryDeviceStatus() {
            const device = document.getElementById('statusDevice').value;

            showStatus('deviceStatus', 'æŸ¥è¯¢ä¸­...', 'info');

            try {
                const response = await fetch(`/zhsf/api/devices/${device}/status`);
                const data = await response.json();

                const rgbMode = data.status.response || 'æœªçŸ¥';
                const micStatus = data.microphone.response === 'g' ? 'é™éŸ³' : data.microphone.response === 'k' ? 'å¼€éº¦' : 'æœªçŸ¥';
                const volume = data.volume.response ? data.volume.response.replace('v', '') + '%' : 'æœªçŸ¥';

                showStatus('deviceStatus',
                    `RGB: ${rgbMode}<br>éº¦å…‹é£: ${micStatus}<br>éŸ³é‡: ${volume}`,
                    'success');
            } catch (error) {
                showStatus('deviceStatus', 'æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡çŠ¶æ€
        async function queryAllDevices() {
            showStatus('deviceStatus', 'æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡ä¸­...', 'info');

            try {
                const response = await fetch('/zhsf/api/devices/status');
                const data = await response.json();

                let result = '';
                for (const [deviceId, deviceData] of Object.entries(data)) {
                    const rgbMode = deviceData.status?.response || 'æœªçŸ¥';
                    const micStatus = deviceData.microphone?.response === 'g' ? 'é™éŸ³' : deviceData.microphone?.response === 'k' ? 'å¼€éº¦' : 'æœªçŸ¥';
                    const volume = deviceData.volume?.response ? deviceData.volume.response.replace('v', '') + '%' : 'æœªçŸ¥';

                    result += `${deviceId}: RGB=${rgbMode}, éº¦å…‹é£=${micStatus}, éŸ³é‡=${volume}<br>`;
                }

                showStatus('deviceStatus', result, 'success');
            } catch (error) {
                showStatus('deviceStatus', 'æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰¹é‡æ§åˆ¶
        function updateBatchParams() {
            const action = document.getElementById('batchAction').value;
            const paramsDiv = document.getElementById('batchParams');

            if (action === 'rgb') {
                paramsDiv.innerHTML = `
                    <label>RGBæ¨¡å¼:</label>
                    <select id="batchRgbMode">
                        <option value="0">å…³é—­</option>
                        <option value="1" selected>ç»¿è‰²å¸¸äº®</option>
                        <option value="2">é»„è‰²é—ªçƒ</option>
                        <option value="3">é»„è‰²å¸¸äº®</option>
                        <option value="4">çº¢è‰²é—ªçƒ</option>
                        <option value="5">çº¢è‰²å¸¸äº®</option>
                        <option value="6">çº¢è“äº¤æ›¿</option>
                    </select>
                `;
            } else if (action === 'microphone') {
                paramsDiv.innerHTML = `
                    <label>éº¦å…‹é£æ“ä½œ:</label>
                    <select id="batchMicAction">
                        <option value="mute">é™éŸ³</option>
                        <option value="unmute">å¼€éº¦</option>
                    </select>
                `;
            } else if (action === 'volume') {
                paramsDiv.innerHTML = `
                    <label>éŸ³é‡è®¾ç½®:</label>
                    <input type="number" id="batchVolume" min="0" max="100" value="10">%
                `;
            }
        }

        async function executeBatchControl() {
            const selectedDevices = [];
            ['zhsf_1', 'zhsf_2', 'zhsf_3'].forEach(id => {
                if (document.getElementById(`batch_${id}`).checked) {
                    selectedDevices.push(id);
                }
            });

            if (selectedDevices.length === 0) {
                showStatus('batchStatus', 'è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªè®¾å¤‡', 'error');
                setTimeout(() => hideStatus('batchStatus'), 3000);
                return;
            }

            const action = document.getElementById('batchAction').value;
            let params = {};

            if (action === 'rgb') {
                params.rgb_mode = document.getElementById('batchRgbMode').value;
            } else if (action === 'microphone') {
                params.microphone = document.getElementById('batchMicAction').value;
            } else if (action === 'volume') {
                params.volume = document.getElementById('batchVolume').value;
            }

            showStatus('batchStatus', 'æ‰¹é‡æ‰§è¡Œä¸­...', 'info');

            const results = [];
            for (const deviceId of selectedDevices) {
                try {
                    const response = await fetch(`/zhsf/api/control/${deviceId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ actions: params })
                    });

                    const result = await response.json();
                    const actionName = action === 'rgb' ? 'RGB' : action === 'microphone' ? 'éº¦å…‹é£' : 'éŸ³é‡';
                    const status = result[action]?.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                    results.push(`${deviceId}(${actionName}): ${status}`);
                } catch (error) {
                    results.push(`${deviceId}: å¤±è´¥ - ${error.message}`);
                }
            }

            showStatus('batchStatus', 'æ‰¹é‡æ“ä½œå®Œæˆ:\n' + results.join('\n'), 'success');
            setTimeout(() => hideStatus('batchStatus'), 5000);
        }

        // å·¥å…·å‡½æ•°
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 3000);
        }

        // ç³»ç»ŸçŠ¶æ€æ›´æ–°
        let systemStatusInterval = null;

        async function refreshSystemStatus() {
            try {
                const response = await fetch('/zhsf/api/system/status');
                const data = await response.json();

                // æ›´æ–°éŸ³é¢‘çŠ¶æ€
                document.getElementById('systemAudioStatus').textContent =
                    `éŸ³é¢‘: ${data.audio.listening ? 'ç›‘å¬ä¸­' : 'æœªç›‘å¬'}`;

                // æ›´æ–°æ•°æ®åŒ…æ•°é‡
                document.getElementById('systemPackets').textContent =
                    `æ•°æ®åŒ…: ${data.audio.packets_received}`;

                // æ›´æ–°è®¾å¤‡æ•°é‡å’Œåœ¨çº¿çŠ¶æ€
                const onlineDevices = Object.values(data.devices).filter(d => d.online).length;
                document.getElementById('systemDevices').textContent =
                    `è®¾å¤‡: ${onlineDevices}/${Object.keys(data.devices).length} åœ¨çº¿`;

                // æ›´æ–°æ—¶é—´æˆ³
                document.getElementById('systemTime').textContent =
                    `æ›´æ–°: ${data.timestamp.split(' ')[1]}`;

                console.log('ç³»ç»ŸçŠ¶æ€å·²æ›´æ–°:', data);
            } catch (error) {
                console.error('ç³»ç»ŸçŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        }

        // å¼€å§‹è‡ªåŠ¨çŠ¶æ€æ›´æ–°
        function startSystemStatusUpdates() {
            refreshSystemStatus(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
            if (!systemStatusInterval) {
                systemStatusInterval = setInterval(refreshSystemStatus, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
            }
        }

        // åœæ­¢è‡ªåŠ¨çŠ¶æ€æ›´æ–°
        function stopSystemStatusUpdates() {
            if (systemStatusInterval) {
                clearInterval(systemStatusInterval);
                systemStatusInterval = null;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateAudioStatus();
            updateBatchParams();
            startSystemStatusUpdates();

            // æ‰¹é‡æ§åˆ¶æ“ä½œç±»å‹å˜æ›´äº‹ä»¶
            document.getElementById('batchAction').addEventListener('change', updateBatchParams);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            stopSystemStatusUpdates();
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });
    </script>
</body>
</html>